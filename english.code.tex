\input{preamble.tex}
\input{review.code.tex}
\geometry{
  paperwidth=250.6mm,
  paperheight=174.1mm,
  left=2cm,
  right=2cm,
  top=2.5cm,
  bottom=2.5cm,
}

\makeatletter
\ExplSyntaxOn
%% variables
% date
\tl_new:N \l__en_date_tl
% \tl_new:N \l__word_tl
% \tl_new:N \l__word_mean_tl
\int_new:N \l__count_int
\clist_new:N \g__temp_clist
% \clist_new:N \g__en_date_clist
\clist_new:N \l__en_review_point_clist
\clist_new:N \g__en_review_date_clist
\clist_new:N \l__en_review_date_clist
\clist_new:N \l__en_review_word_clist
\clist_new:N \g__word_card_upper_clist
\clist_new:N \g__word_card_lower_clist
\dim_new:N \l__en_word_sep_dim
\dim_new:N \l__en_word_indent_dim
\box_new:N \l__word_hbox
\box_new:N \l__word_mean_hbox

\clist_set:Nn \l__en_review_point_clist {1,2,4,7}
\dim_set:Nn \l__en_word_sep_dim {1em}
\dim_set:Nn \l__en_word_indent_dim {1em}

\AtEndDocument
  {
    \wq_write_to_aux:x
      {
        \gdef\token_to_str:N \en@reviewdate
        {\clist_use:Nn \g__en_review_date_clist {,}}
      }
  }

\cs_new_protected:Npn \wq_write_to_aux:n #1
  {
    \legacy_if:nT {@filesw} { \iow_now:Nn \@auxout {#1} }
  }
\cs_generate_variant:Nn \wq_write_to_aux:n {x}

\prg_new_protected_conditional:Nnn \en_review_if: {T, F, TF}
  {
    \review_if:NnTF \l__en_review_point_clist {\l__en_date_tl}
      {\prg_return_true:}
      {\prg_return_false:}
  }

\cs_new_protected:Npn \save_wordlist:n #1
  {
    \wq_write_to_aux:x
      {
        \token_to_str:N \expandafter\gdef
        \exp_not:N \csname wordreview#1
        \token_to_str:N \endcsname
        {\clist_use:Nn \g__temp_clist {,}}
      }
  }

\NewDocumentCommand {\word} { m D(){} O{} +m }
  {
    \int_incr:N \l__count_int
    \en_review_if:T {\clist_gput_right:Nn \g__temp_clist {#1}}
    % \clist_gput_right:cn {g__word_card_upper_\l__temp_date_tl _clist}
    \clist_gput_right:cn {g__word_card_upper_\l__en_date_tl _clist}
      {
        \zihao{0}
        #1\tl_if_blank:nF {#2} {\textipa{[#2]}}
        \quad
        \tl_if_blank:nF {#3} {#3.~}
      }
    % \clist_gput_right:cn {g__word_card_lower_\l__temp_date_tl _clist}
    \clist_gput_right:cn {g__word_card_lower_\l__en_date_tl _clist}
      {\zihao{0}#4}
    \__en_word_item:nn
      {
        \int_use:N \l__count_int.~#1
        \tl_if_blank:nF {#2} {\textipa{[#2]}}
      }
      {\tl_if_blank:nF {#3} {#3.~}#4}
  }

\NewDocumentCommand {\wordcard} {}
  {
    \clearpage
    % \pdfpageheight=174.1mm
    % \pdfpagewidth=250.6mm
    % \newgeometry{
      % layoutwidth=250.6mm,
      % layoutheight=174.1mm,
      % left=2cm,
      % right=2cm,
      % top=2.5cm,
      % bottom=2.5cm,
    % }
    \clist_map_inline:Nn \g__en_review_date_clist
      {
        \int_step_inline:nn
          {\clist_count:c {g__word_card_lower_##1_clist}}
          {
            \clearpage
            % \customlabel{card:##1-####1}{##1}
            \customlabel{card:####1}{##1}
            \begin{tcolorbox}[
              title={
                \hyperref[review-word:##1-####1]{
                  \clist_item:cn {g__word_card_upper_##1_clist} {####1}
                }
              },
              fonttitle=\raggedright\sffamily,
              fontupper=\itshape,
              height=\textheight,
              width=\textwidth,
              boxrule=2pt,
              arc=3mm,
              boxsep=1em,
            ]
              \clist_item:cn {g__word_card_lower_##1_clist} {####1}
            \end{tcolorbox}
          }
      }
  }

\cs_new_protected:Npn \__en_word_item:nn #1#2
  {
    \hbox_set:Nn \l__word_hbox {#1}
    \hbox_set:Nn \l__word_mean_hbox{#2}
    % \customlabel{review-word:\l__endate_tl-\l__count_int}{}
    \parbox{\linewidth}{
      {\sffamily\bfseries#1}
      \dim_compare:nTF
        {
          \box_wd:N \l__word_hbox +
          \box_wd:N \l__word_mean_hbox +
          \l__en_word_sep_dim >
          \linewidth
        }
        { \par\hangindent=1em\hspace{\l__en_word_indent_dim} }
        { \hspace{\l__en_word_sep_dim} }
      {\itshape#2}
    }\par\vspace{2mm}
  }

\NewDocumentEnvironment {baselist} { m +b }
  {
    \subsection*{\Large\bfseries\sffamily\color{teal}#1}
    \begin{multicols}{2}
      #2
      \vspace*{\fill}
    \end{multicols}
  } {}

\NewDocumentCommand {\enreview} { }
  {
    \subsection*{\sffamily REVIEW~TODAY}
    Date:\today\par\vspace{1cm}
    \clist_set:No \l__en_review_date_clist
      {\cs_if_exist_use:c {en@reviewdate}}
    \clist_map_inline:Nn \l__en_review_date_clist
      {
        \customlabel{review:##1}{##1}
        \clist_clear_new:c {g__word_card_upper_##1_clist}
        \clist_clear_new:c {g__word_card_lower_##1_clist}
        \tl_clear_new:N \l__temp_date_tl
        \tl_set:Nn \l__temp_date_tl {##1}
        \begin{baselist}{\hyperref[enlist:##1]{##1~review}}
          \int_set:Nn \l__count_int {0}
          \clist_set:Nx \l__en_review_word_clist {\exp_not:v {wordreview##1}}
          \sffamily\bfseries\large
          \clist_map_inline:Nn \l__en_review_word_clist
            {
              \int_incr:N \l__count_int
              \customlabel{review-word:##1-\int_use:N \l__count_int}{}
              \hyperref[card:\int_use:N \l__count_int]{
                \int_use:N \l__count_int.~
                ####1
              }
              \par\vspace{2mm}
            }
        \end{baselist}
      }
    \clearpage
  }

% #1 date
\NewDocumentEnvironment {wordlist} { m +b }
  {
    \tl_set:Nn \l__en_date_tl {#1}
    \int_set:Nn \l__count_int {0}
    \clist_clear:N \g__temp_clist
    \clist_gclear_new:c { g__#1_number_clist }
    \customlabel{enlist:#1}{#1}
    \begin{baselist}
      {
        #1
        \en_review_if:T
          {
            \reviewtoday{\hyperref[review:#1]{今日复习}}
          }
      }
      #2
    \end{baselist}
    \en_review_if:T
      {
        \clist_gput_right:Nn \g__en_review_date_clist {#1}
        \save_wordlist:n {#1}
      }
  } {}

\NewDocumentCommand {\enhint} { +m }
  {
    {\\\normalfont（#1）}
  }

\NewDocumentCommand {\enem} { +m }
  {
    {\sffamily#1}
  }

\ExplSyntaxOff
\makeatother

\input{preamble.tex}
\input{review.code.tex}
\geometry{
  paperwidth=250.6mm,
  paperheight=174.1mm,
  left=2cm,
  right=2cm,
  top=2.5cm,
  bottom=2.5cm,
}
\ctexset{
  subsection/numbering=false,
  subsection/format=\Large\bfseries\sffamily\color{teal},
}

\fancyhf{}
\lhead{\itshape\rightmark}
\rhead{\thepage}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\setlength\headheight{15pt}

\etocmulticolstyle[2]{
  \noindent\bfseries\Large
  \leaders\hrule height1pt\hfill
  \MakeUppercase{Table of Contents}
}

\ExplSyntaxOn
\clist_new:N \g__en_date_clist
\clist_new:N \g__en_review_date_clist
\clist_new:N \g__en_review_point_clist
\int_new:N \l__count_int
\int_new:N \g__review_int

\clist_gset:Nn \g__en_review_point_clist {1,2,4,7}

\AtBeginDocument
  {
    \tableofcontents
    \clearpage
  }
\AtEndDocument
  {
    \show_word:
    \show_review_word:
    \show_word_card:
  }

\prg_new_protected_conditional:Nnn \en_review_if:n { T, F, TF }
  {
    \review_if:NnTF \g__en_review_point_clist { #1 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\NewDocumentEnvironment {wordlist} { m +b }
  {
    \group_begin:
    \tl_clear_new:N \l__en_date_tl
    \tl_set:Nn \l__en_date_tl { #1 }
    \clist_gput_right:Nn \g__en_date_clist { #1 }
    \clist_gclear_new:c { g__saved_word_#1 }
    \clist_gclear_new:c { g__saved_complete_word_#1 }
    \clist_gclear_new:c { g__saved_word_meaning_#1 }
    \en_review_if:nT { #1 }
      {
        \clist_gput_right:Nn \g__en_review_date_clist { #1 }
      }
    #2
    \group_end:
  } {}

% #1 date you do not remember again
% #2 word, #3 音标, #4 词性, #5 解释
\NewDocumentCommand { \word } { O{} m D(){} O{} +m }
  {
    \errorprone_word:Nn \l__en_date_tl { #1 }
    \en_review_if:nT { \l__en_date_tl }
      { \save_word:Nn \l__en_date_tl { #2 } }
    \save_comlete_word:Nnnn \l__en_date_tl { #2 } { #3 } { #4 }
    \save_word_meaning:Nn \l__en_date_tl { #5 }
  }

\cs_new_protected:Nn \errorprone_word:Nn
  {
  }

\cs_new_protected:Nn \save_word:Nn
  {
    \clist_gput_right:cn { g__saved_word_#1 } { #2 }
  }

\cs_new_protected:Nn \save_comlete_word:Nnnn
  {
    \clist_gput_right:cn { g__saved_complete_word_#1 }
    {
      {\sffamily\bfseries#2}
      \tl_if_blank:nF { #3 } { \textipa{[#3]} }
      \quad{\normalfont\itshape{\tl_if_blank:nF { #4 } { #4.~ }}}
    }
  }

\cs_new_protected:Nn \save_word_meaning:Nn
  {
    \clist_gput_right:cn { g__saved_word_meaning_#1 } { \itshape#2 }
  }

\cs_new_protected:Nn \show_review_word:
  {
    \phantomsection
    \addcontentsline{toc}{section}{单词测试}
    \subsection*{\sffamily REVIEW~TODAY}
    Date:\today\par\vspace{1cm}
    \clist_map_inline:Nn \g__en_review_date_clist
      {
        \customlabel{review:##1}
        \subsection*{\Large\bfseries\sffamily\color{teal}##1~review}
        \markright{##1单词测试}
        \addcontentsline{toc}{subsection}{##1单词测试}
        \reviewtoday{\hyperref[wordlist:##1]{返回列表}}
        \begin{baselist}[itemsep=1em]
          \int_zero:N \l__count_int
          \clist_map_inline:cn { g__saved_word_##1 }
            {
              \int_incr:N \l__count_int
              \item \customlabel{review_word:##1_\int_use:N \l__count_int}
                {
                  \sffamily\bfseries\huge
                  \hyperref[card:##1_\int_use:N \l__count_int]{####1}
                }
            }
        \end{baselist}
      }
    \clearpage
  }

\cs_new_protected:Nn \show_next_review:
  {

  }

\cs_new_protected:Nn \show_word:
  {
    \phantomsection
    \addcontentsline{toc}{section}{单词列表}
    \int_gzero:N \g__review_int
    \clist_map_inline:Nn \g__en_date_clist
      {
        \subsection*{\Large\bfseries\sffamily\color{teal}##1}
        \markright{##1单词列表}
        \en_review_if:nT { ##1 } { \bookmarksetupnext{bold} }
        \en_review_if:nTF { ##1 }
          {
            \addcontentsline{toc}{subsection}{
              \texorpdfstring{\color{red}##1单词列表}{##1单词列表}
            }
          }
          { \addcontentsline{toc}{subsection}{##1单词列表} }
        \en_review_if:nT { ##1 }
          {
            \int_gincr:N \g__review_int
            \bookmarksetupnext{bold}
            \label{wordlist:##1}
            \reviewtoday{\hyperref[review:##1]{前往测试}}
          }
        \begin{baselist}[font=\sffamily\Large]
          \int_step_inline:nn
            { \clist_count:c { g__saved_complete_word_##1 } }
            {
              \item
              \begingroup
              \Large
              \clist_item:cn
                { g__saved_complete_word_##1 }
                { ####1 }
              \par
              \clist_item:cn
                { g__saved_word_meaning_##1 }
                { ####1 }
              \endgroup
            }
        \end{baselist}
        \en_review_if:nT { ##1 } { \show_next_review: }
      }
    \clearpage
  }

\cs_new_protected:Nn \show_word_card:
  {
    \clist_map_inline:Nn \g__en_review_date_clist
      {
        \int_step_inline:nn
          { \clist_count:c { g__saved_complete_word_##1 } }
          {
            \customlabel{card:##1_####1}
            \begin{tcolorbox}[
              title={
                  \zihao{0}
                  \hyperref[review_word:##1_####1]{
                    \clist_item:cn
                      { g__saved_complete_word_##1 }
                      { ####1 }
                  }
                },
              fonttitle=\raggedright\sffamily,
              fontupper=\itshape,
              height=\textheight,
              width=\textwidth,
              boxrule=2pt,
              arc=3mm,
              boxsep=1em,
            ]
              \zihao{0}
              \clist_item:cn
                { g__saved_word_meaning_##1 }
                { ####1 }
            \end{tcolorbox}
            \clearpage
          }
      }
  }

\NewDocumentEnvironment {baselist} { O{} +b }
  {
    \begin{multicols}{2}
      \begin{enumerate}[
        font=\sffamily\huge,
        #1
        ]
        #2
        \item[] \vspace*{\fill}
      \end{enumerate}
    \end{multicols}
  } {}

\NewDocumentCommand {\enhint} { +m }
  {
    {\\\normalfont（#1）}
  }

\NewDocumentCommand {\enem} { +m }
  {
    {\sffamily#1}
  }
\ExplSyntaxOff

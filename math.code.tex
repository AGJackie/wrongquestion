\input{preamble.tex}
\input{review.code.tex}
\everymath{\displaystyle}
\setlength\parindent{0pt}

\geometry{
  left=2cm,
  right=2cm,
  top=2.5cm,
  bottom=2.5cm,
}

\newcommand{\mathblank}{\CJKunderline[hidden]{四个汉字}}

\newcommand{\mathhint}[1]{
  \tcbset{highlight math style={colframe=teal, colback=teal!10}}
  \tcbhighmath[boxrule=0.6pt]{#1}
}

\newcommand{\matherror}[1]{
  \tcbset{highlight math style={colframe=red, colback=red!10}}
  \tcbhighmath[boxrule=0.6pt]{#1}
}

\newtcbox{\mathidea}{
  colframe=teal, colback=teal!10, on line,
}

\newtcbox{\mathtype}{
  colframe=teal, colback=teal!30!cyan,
  size=small, on line,
}

\newtcbox{\mathlink}{
  colframe=teal, colback=teal!30!yellow,
  size=small, on line,
  fontupper=\sffamily,
}

\newtcolorbox{mathideabox}{
  colframe=teal, colback=teal!10, breakable,
}

\newtcolorbox[use counter=step]{step}[1]{
  title={Step \arabic{step}: #1},
  breakable,
}

\newcounter{step}

\ExplSyntaxOn

\AtEndDocument{
  \math_show:
}

\cs_new_protected:Nn \math_def_seq:n
  {
    \seq_new:c { g__math_saved_all_#1_seq }
    \seq_new:c { g__math_saved_review_#1_seq }
    \seq_new:c { g__math_saved_more_#1_seq }
  }

\tl_new:N       \l__math_date_tl
\tl_new:N       \l__math_type_tl
\tl_new:N       \l__math_info_tl
\tl_new:N       \l__math_content_ques_tl
\tl_new:N       \l__math_number_style_tl
\int_new:N      \l__math_mistake_number_int
\int_new:N      \l__math_count_int
\dim_new:N      \l__math_ques_after_title_dim
\bool_new:N     \l__show_all_bool
\clist_new:N    \l__math_review_point_clist
\math_def_seq:n { date }
\math_def_seq:n { type }
\math_def_seq:n { info }
\math_def_seq:n { content_ques }
\math_def_seq:n { content_solu }
\math_def_seq:n { mistake_number }

\clist_set:Nn     \l__math_review_point_clist { 2,4,7,15,30 }
\bool_set_false:N \l__show_all_bool

\keys_define:nn { mathques }
  {
    show~all     . bool_set:N = \l__show_all_bool,
    show~all     . default:n  = { true },
    number~style . tl_set:N   = \l__math_number_style_tl,
    after~title  . dim_set:N  = \l__math_ques_after_title_dim,
  }

\NewDocumentCommand { \mathsetup } { +m }
  {
    \keys_set:nn { mathques } { #1 }
  }

\prg_new_protected_conditional:Nnn \math_review_if:n { T, F, TF }
  {
    \review_if:NnTF \l__math_review_point_clist { #1 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1 date #2 seq name #3 data to save
\cs_new_protected:Nn \math_save:nnn
  {
    \bool_if:NT \l__show_all_bool
      {
        \seq_gput_right:cn { g__math_saved_all_#2_seq } { #3 }
      }
    \math_review_if:nT { #1 }
      {
        \seq_gput_right:cn { g__math_saved_review_#2_seq } { #3 }
      }
  }

% #1 做错次数 #2 做错日期 #3 题目类型
  \NewDocumentEnvironment { mathques } { O{} D(){1} m m +b }
  {
    \tl_clear_new:N \l__math_date_tl

    \tl_set:Nn \l__math_date_tl { #3 }

    #5

    \math_save:nnn { #3 } { date } { #3 }
    \math_save:nnn { #3 } { type } { #4 }
    \math_save:nnn { #3 } { mistake_number } { #2 }
  } { }

\NewDocumentCommand { \info } { +m }
  {
    \math_save:nnn { \l__math_date_tl } { info } { #1 }
  }

\NewDocumentEnvironment { ques } { +b }
  {
    \math_save:nnn { \l__math_date_tl } { content_ques } { #1 }
  } { }

\NewDocumentEnvironment { solu } { +b }
  {
    \math_save:nnn { \l__math_date_tl } { content_solu } { #1 }
  } { }

\cs_new_protected:Nn \math_show:
  {
      { \math_show_content_template:n { review } }
    \bool_if:NT \l__show_all_bool
      { \math_show_content_template:n { all } }
  }

\cs_new_protected:Nn \math_show_content_template:n
  {
    \math_show_content:nn { #1 } { ques }
    \clearpage
    \math_show_content:nn { #1 } { solu }
  }

% #1 all/review #2 ques/solu
\cs_new_protected:Nn \math_show_content:nn
  {
    \int_zero:N \l__math_count_int
    \seq_map_inline:cn { g__math_saved_#1_content_#2_seq }
      {
        \setcounter{step}{0}
        \int_incr:N \l__math_count_int
        \math_set:nn { #1 } { \l__math_count_int }
        \cs_if_exist_use:c { math_wrap_content_#2:nn } { #1 } { ##1 }
      }
  }

% #1 all/review/more #2 int
\cs_new_protected:Nn \math_set:nn
  {
    \tl_set:Nn \l__math_date_tl
      { \math_seq_item:nnn { #1 } { date } { #2 } }
    \tl_set:Nn \l__math_type_tl
      { \math_seq_item:nnn { #1 } { type } { #2 } }
    \tl_set:Nn \l__math_info_tl
      { \math_seq_item:nnn { #1 } { info } { #2 } }
    \tl_set:Nn \l__math_content_ques_tl
      { \math_seq_item:nnn { #1 } { content_ques } { #2 } }
    \int_set:Nn \l__math_mistake_number_int
      { \math_seq_item:nnn { #1 } { mistake_number } { #2 } }
  }

% #1 all/review/more #2 date/type... #3 int
\cs_new:Nn \math_seq_item:nnn
  {
    \seq_item:cn { g__math_saved_#1_#2_seq } { #3 }
  }

% #1 all/review... #2 content
\cs_new_protected:Nn \math_wrap_content_ques:nn
  {
    \customlabel{#1_ques:\int_use:N \l__math_count_int}
    \begin{tcolorbox}
      {
        \l__math_number_style_tl
        \int_use:N \l__math_count_int
      }.~
      \mathtype{ \l__math_type_tl }
      \mathlink{
        \hyperref[#1_solu:\int_use:N \l__math_count_int]{
          前往答案
        }
      }
      \par\vspace{\l__math_ques_after_title_dim}
      #2
    \end{tcolorbox}
  }

\cs_new_protected:Nn \math_wrap_content_solu:nn
  {
    \par
    \customlabel{#1_solu:\int_use:N \l__math_count_int}
    {
      \l__math_number_style_tl
      \int_use:N \l__math_count_int
    }.~
    \mathtype{ \l__math_type_tl }
    \mathlink{
      \hyperref[#1_ques:\int_use:N \l__math_count_int]{
        返回题目
      }
    }
    \par\vspace{\l__math_ques_after_title_dim}
    {\sffamily\bfseries 题目：}\l__math_content_ques_tl
    \par{\sffamily\bfseries 答案：}
    #2 \par
  }

\ExplSyntaxOff

\mathsetup{
  show all=false,
  number style={ \zihao{3}\color{teal}\itshape\bfseries },
  after title=1em,
}
